/*

// ==UserScript==
// @name           Chat Reply Helper for Stack Exchange sites
// @namespace      http://oliversalzburg.github.com/
// @version        2.5.1
// @description    Handle structured conversations more conveniently
// @homepage       https://github.com/oliversalzburg/se-chat-reply-highlight
// @grant          none
// @include /^https?:\/\/chat\.stackexchange\.com/.*$/
// @include /^https?:\/\/chat\.stackoverflow\.com/.*$/
// @include /^https?:\/\/chat\.meta\.stackexchange\.com/.*$/

// ==/UserScript==
*/
"undefined"==typeof jQuery.migrateMute&&(jQuery.migrateMute=!0);
(function(a,d,k){function e(c){var b=d.console;m[c]||(m[c]=!0,a.migrateWarnings.push(c),b&&b.warn&&!a.migrateMute&&(b.warn("JQMIGRATE: "+c),a.migrateTrace&&b.trace&&b.trace()))}function f(c,b,h,d){if(Object.defineProperty)try{return void Object.defineProperty(c,b,{configurable:!0,enumerable:!0,get:function(){return e(d),h},set:function(a){e(d);h=a}})}catch(p){}a._definePropertyBroken=!0;c[b]=h}a.migrateVersion="1.4.1";var m={};a.migrateWarnings=[];d.console&&d.console.log&&d.console.log("JQMIGRATE: Migrate is installed"+
(a.migrateMute?"":" with logging active")+", version "+a.migrateVersion);a.migrateTrace===k&&(a.migrateTrace=!0);a.migrateReset=function(){m={};a.migrateWarnings.length=0};"BackCompat"===document.compatMode&&e("jQuery is not compatible with Quirks Mode");var g=a("<input/>",{size:1}).attr("size")&&a.attrFn,l=a.attr,q=a.attrHooks.value&&a.attrHooks.value.get||function(){return null},n=a.attrHooks.value&&a.attrHooks.value.set||function(){return k},u=/^(?:input|button)$/i,r=/^[238]$/,t=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,
F=/^(?:checked|selected)$/i;f(a,"attrFn",g||{},"jQuery.attrFn is deprecated");a.attr=function(c,b,h,d){var p=b.toLowerCase(),f=c&&c.nodeType;return d&&(4>l.length&&e("jQuery.fn.attr( props, pass ) is deprecated"),c&&!r.test(f)&&(g?b in g:a.isFunction(a.fn[b])))?a(c)[b](h):("type"===b&&h!==k&&u.test(c.nodeName)&&c.parentNode&&e("Can't change the 'type' of an input or button in IE 6/7/8"),!a.attrHooks[p]&&t.test(p)&&(a.attrHooks[p]={get:function(c,b){var h,e=a.prop(c,b);return!0===e||"boolean"!=typeof e&&
(h=c.getAttributeNode(b))&&!1!==h.nodeValue?b.toLowerCase():k},set:function(c,b,h){var e;return!1===b?a.removeAttr(c,h):(e=a.propFix[h]||h,e in c&&(c[e]=!0),c.setAttribute(h,h.toLowerCase())),h}},F.test(p)&&e("jQuery.fn.attr('"+p+"') might use property instead of attribute")),l.call(a,c,b,h))};a.attrHooks.value={get:function(a,b){var h=(a.nodeName||"").toLowerCase();return"button"===h?q.apply(this,arguments):("input"!==h&&"option"!==h&&e("jQuery.fn.attr('value') no longer gets properties"),b in a?
a.value:null)},set:function(a,b){var h=(a.nodeName||"").toLowerCase();return"button"===h?n.apply(this,arguments):("input"!==h&&"option"!==h&&e("jQuery.fn.attr('value', val) no longer sets properties"),void(a.value=b))}};var v,s,z=a.fn.init,w=a.find,G=a.parseJSON,H=/^\s*</,I=/\[(\s*[-\w]+\s*)([~|^$*]?=)\s*([-\w#]*?#[-\w#]*)\s*\]/,J=/\[(\s*[-\w]+\s*)([~|^$*]?=)\s*([-\w#]*?#[-\w#]*)\s*\]/g,K=/^([^<]*)(<[\w\W]+>)([^>]*)$/;a.fn.init=function(c,b,h){var d,p;return c&&"string"==typeof c&&!a.isPlainObject(b)&&
(d=K.exec(a.trim(c)))&&d[0]&&(H.test(c)||e("$(html) HTML strings must start with '<' character"),d[3]&&e("$(html) HTML text after last tag is ignored"),"#"===d[0].charAt(0)&&(e("HTML string cannot start with a '#' character"),a.error("JQMIGRATE: Invalid selector string (XSS)")),b&&b.context&&b.context.nodeType&&(b=b.context),a.parseHTML)?z.call(this,a.parseHTML(d[2],b&&b.ownerDocument||b||document,!0),b,h):(p=z.apply(this,arguments),c&&c.selector!==k?(p.selector=c.selector,p.context=c.context):(p.selector=
"string"==typeof c?c:"",c&&(p.context=c.nodeType?c:b||document)),p)};a.fn.init.prototype=a.fn;a.find=function(a){var b=Array.prototype.slice.call(arguments);if("string"==typeof a&&I.test(a))try{document.querySelector(a)}catch(h){a=a.replace(J,function(a,c,b,h){return"["+c+b+'"'+h+'"]'});try{document.querySelector(a),e("Attribute selector with '#' must be quoted: "+b[0]),b[0]=a}catch(d){e("Attribute selector with '#' was not fixed: "+b[0])}}return w.apply(this,b)};for(var x in w)Object.prototype.hasOwnProperty.call(w,
x)&&(a.find[x]=w[x]);a.parseJSON=function(a){return a?G.apply(this,arguments):(e("jQuery.parseJSON requires a valid JSON string"),null)};a.uaMatch=function(a){a=a.toLowerCase();a=/(chrome)[ \/]([\w.]+)/.exec(a)||/(webkit)[ \/]([\w.]+)/.exec(a)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(a)||/(msie) ([\w.]+)/.exec(a)||0>a.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(a)||[];return{browser:a[1]||"",version:a[2]||"0"}};a.browser||(v=a.uaMatch(navigator.userAgent),s={},v.browser&&(s[v.browser]=
!0,s.version=v.version),s.chrome?s.webkit=!0:s.webkit&&(s.safari=!0),a.browser=s);f(a,"browser",a.browser,"jQuery.browser is deprecated");a.boxModel=a.support.boxModel="CSS1Compat"===document.compatMode;f(a,"boxModel",a.boxModel,"jQuery.boxModel is deprecated");f(a.support,"boxModel",a.support.boxModel,"jQuery.support.boxModel is deprecated");a.sub=function(){function c(a,b){return new c.fn.init(a,b)}a.extend(!0,c,this);c.superclass=this;c.fn=c.prototype=this();c.fn.constructor=c;c.sub=this.sub;c.fn.init=
function(h,e){var d=a.fn.init.call(this,h,e,b);return d instanceof c?d:c(d)};c.fn.init.prototype=c.fn;var b=c(document);return e("jQuery.sub() is deprecated"),c};a.fn.size=function(){return e("jQuery.fn.size() is deprecated; use the .length property"),this.length};var y=!1;a.swap&&a.each(["height","width","reliableMarginRight"],function(c,b){var h=a.cssHooks[b]&&a.cssHooks[b].get;h&&(a.cssHooks[b].get=function(){var a;return y=!0,a=h.apply(this,arguments),y=!1,a})});a.swap=function(a,b,h,d){var f,
g={};y||e("jQuery.swap() is undocumented and deprecated");for(f in b)g[f]=a.style[f],a.style[f]=b[f];h=h.apply(a,d||[]);for(f in b)a.style[f]=g[f];return h};a.ajaxSetup({converters:{"text json":a.parseJSON}});var L=a.fn.data;a.fn.data=function(c){var b,h,d=this[0];return!d||"events"!==c||1!==arguments.length||(b=a.data(d,c),h=a._data(d,c),b!==k&&b!==h||h===k)?L.apply(this,arguments):(e("Use of jQuery.fn.data('events') is deprecated"),h)};var M=/\/(java|ecma)script/i;a.clean||(a.clean=function(c,b,
h,d){b=b||document;b=!b.nodeType&&b[0]||b;b=b.ownerDocument||b;e("jQuery.clean() is deprecated");var f,g,k=[];if(a.merge(k,a.buildFragment(c,b).childNodes),h)for(f=function(a){return!a.type||M.test(a.type)?d?d.push(a.parentNode?a.parentNode.removeChild(a):a):h.appendChild(a):void 0},c=0;null!=(b=k[c]);c++)a.nodeName(b,"script")&&f(b)||(h.appendChild(b),"undefined"!=typeof b.getElementsByTagName&&(g=a.grep(a.merge([],b.getElementsByTagName("script")),f),k.splice.apply(k,[c+1,0].concat(g)),c+=g.length));
return k});var N=a.event.add,O=a.event.remove,P=a.event.trigger,Q=a.fn.toggle,A=a.fn.live,B=a.fn.die,R=a.fn.load,C=/\b(?:ajaxStart|ajaxStop|ajaxSend|ajaxComplete|ajaxError|ajaxSuccess)\b/,D=/(?:^|\s)hover(\.\S+|)\b/,E=function(c){return"string"!=typeof c||a.event.special.hover?c:(D.test(c)&&e("'hover' pseudo-event is deprecated, use 'mouseenter mouseleave'"),c&&c.replace(D,"mouseenter$1 mouseleave$1"))};a.event.props&&"attrChange"!==a.event.props[0]&&a.event.props.unshift("attrChange","attrName",
"relatedNode","srcElement");a.event.dispatch&&f(a.event,"handle",a.event.dispatch,"jQuery.event.handle is undocumented and deprecated");a.event.add=function(a,b,d,f,g){a!==document&&C.test(b)&&e("AJAX events should be attached to document: "+b);N.call(this,a,E(b||""),d,f,g)};a.event.remove=function(a,b,d,e,f){O.call(this,a,E(b)||"",d,e,f)};a.each(["load","unload","error"],function(c,b){a.fn[b]=function(){var a=Array.prototype.slice.call(arguments,0);return"load"===b&&"string"==typeof a[0]?R.apply(this,
a):(e("jQuery.fn."+b+"() is deprecated"),a.splice(0,0,b),arguments.length?this.bind.apply(this,a):(this.triggerHandler.apply(this,a),this))}});a.fn.toggle=function(c,b){if(!a.isFunction(c)||!a.isFunction(b))return Q.apply(this,arguments);e("jQuery.fn.toggle(handler, handler...) is deprecated");var d=arguments,f=c.guid||a.guid++,g=0,k=function(b){var e=(a._data(this,"lastToggle"+c.guid)||0)%g;return a._data(this,"lastToggle"+c.guid,e+1),b.preventDefault(),d[e].apply(this,arguments)||!1};for(k.guid=
f;g<d.length;)d[g++].guid=f;return this.click(k)};a.fn.live=function(c,b,d){return e("jQuery.fn.live() is deprecated"),A?A.apply(this,arguments):(a(this.context).on(c,this.selector,b,d),this)};a.fn.die=function(c,b){return e("jQuery.fn.die() is deprecated"),B?B.apply(this,arguments):(a(this.context).off(c,this.selector||"**",b),this)};a.event.trigger=function(a,b,d,f){return d||C.test(a)||e("Global events are undocumented and deprecated"),P.call(this,a,b,d||document,f)};a.each("ajaxStart ajaxStop ajaxSend ajaxComplete ajaxError ajaxSuccess".split(" "),
function(c,b){a.event.special[b]={setup:function(){var c=this;return c!==document&&(a.event.add(document,b+"."+a.guid,function(){a.event.trigger(b,Array.prototype.slice.call(arguments,1),c,!0)}),a._data(this,b,a.guid++)),!1},teardown:function(){return this!==document&&a.event.remove(document,b+"."+a._data(this,b)),!1}}});a.event.special.ready={setup:function(){this===document&&e("'ready' event is deprecated")}};var S=a.fn.andSelf||a.fn.addBack,T=a.fn.find;if(a.fn.andSelf=function(){return e("jQuery.fn.andSelf() replaced by jQuery.fn.addBack()"),
S.apply(this,arguments)},a.fn.find=function(a){var b=T.apply(this,arguments);return b.context=this.context,b.selector=this.selector?this.selector+" "+a:a,b},a.Callbacks){var U=a.Deferred,V=[["resolve","done",a.Callbacks("once memory"),a.Callbacks("once memory"),"resolved"],["reject","fail",a.Callbacks("once memory"),a.Callbacks("once memory"),"rejected"],["notify","progress",a.Callbacks("memory"),a.Callbacks("memory")]];a.Deferred=function(c){var b=U(),d=b.promise();return b.pipe=d.pipe=function(){var c=
arguments;return e("deferred.pipe() is deprecated"),a.Deferred(function(e){a.each(V,function(f,g){var k=a.isFunction(c[f])&&c[f];b[g[1]](function(){var b=k&&k.apply(this,arguments);b&&a.isFunction(b.promise)?b.promise().done(e.resolve).fail(e.reject).progress(e.notify):e[g[0]+"With"](this===d?e.promise():this,k?[b]:arguments)})});c=null}).promise()},b.isResolved=function(){return e("deferred.isResolved is deprecated"),"resolved"===b.state()},b.isRejected=function(){return e("deferred.isRejected is deprecated"),
"rejected"===b.state()},c&&c.call(b,b),b}}})(jQuery,window);
(function(a,d,k,e){a.fn.caret=function(f,m){var g,l,q=this[0],n=a.browser.msie;if("object"===typeof f&&"number"===typeof f.start&&"number"===typeof f.end)g=f.start,l=f.end;else if("number"===typeof f&&"number"===typeof m)g=f,l=m;else if("string"===typeof f)-1<(g=q.value.indexOf(f))?l=g+f[d]:g=null;else if("[object RegExp]"===Object.prototype.toString.call(f)){var u=f.exec(q.value);null!=u&&(g=u.index,l=g+u[0][d])}if("undefined"!=typeof g)return n?(n=this[0].createTextRange(),n.collapse(!0),n.moveStart("character",
g),n.moveEnd("character",l-g),n.select()):(this[0].selectionStart=g,this[0].selectionEnd=l),this[0].focus(),this;if(n)if(l=document.selection,"textarea"!=this[0].tagName.toLowerCase()){n=this.val();g=l[k]()[e]();g.moveEnd("character",n[d]);var r=""==g.text?n[d]:n.lastIndexOf(g.text);g=l[k]()[e]();g.moveStart("character",-n[d]);var t=g.text[d]}else g=l[k](),l=g[e](),l.moveToElementText(this[0]),l.setEndPoint("EndToEnd",g),r=l.text[d]-g.text[d],t=r+g.text[d];else r=q.selectionStart,t=q.selectionEnd;
g=q.value.substring(r,t);return{start:r,end:t,text:g,replace:function(a){return q.value.substring(0,r)+a+q.value.substring(t,q.value[d])}}}})($,"length","createRange","duplicate");$.fn.reverse=[].reverse;function ReplyHelper(){this.insertStyles();this.registerHandler();this.enableQuoteBubble()}
ReplyHelper.prototype={quotedMessage:null,replyTo:function(a,d){d=d||":";var k="";":"==d||d.match(/ $/)||(k=" ");var e=$("#input"),f=e.caret().start,k=e.val().replace(RegExp("^"+d+"\\d* ?"),d+k+a+" ");e.val(k);e.caret(f,f)},scrollTo:function(a){var d=$("main.scrollable");d.length?(a=a.offset().top-d.offset().top+d.scrollTop()-a.closest(".user-container").find(".signature").height(),0>a&&(a=0),d.animate({scrollTop:a},50)):a.offset()&&(a=a.offset().top-10,0>a&&(a=0),$("html, body").animate({scrollTop:a},
50))},insertStyles:function(){var a=document.createElement("style");a.textContent="div.message.reply-parent, div.message.reply-child { background-color: silver; }";a.type="text/css";document.head.appendChild(a)},updateReply:function(a,d){a.addClass("reply-child se-highlight-helper");this.scrollTo(a);var k=a.attr("id");k&&this.replyTo(k.substring(8),d)},registerHandler:function(){var a=this;$("#input").keydown(function(d){var k=$("#input");if(!k.hasClass("editing")){var e=k.val(),f=e.match(/^(:|!!telll? ?|!!s\/.*\/.*\/\w* ?)($|\d+| )/);
if(f){if(38==d.keyCode||40==d.keyCode){var m=f[1];if(!(k.caret().start>f[0].length+1)){var f=38==d.keyCode?-1:1,g=$(".reply-child.se-highlight-helper");if(0<g.length){g=g.first();g.removeClass("reply-child se-highlight-helper");var l=$(".messages .message");-1==f&&(l=l.reverse());l.each(function(d,e){if($(e).attr("id")==g.attr("id")){var f=$(l[d+1]).first();f&&a.updateReply(f,m)}})}else{l=$(".messages .message");f=l.last();if(!f)return;a.updateReply(f,m);e==m&&(e=k.val().length,k.caret(e,e))}d.preventDefault()}}}else $(".reply-child.se-highlight-helper").removeClass("reply-child se-highlight-helper")}});
$(document).on("click",".newreply",function(d){a.updateReply($(this).parents(".messages .message"))})},enableQuoteBubble:function(){$(document).on("mousemove",function(a){if(null!=replyHelper.quotedMessage){var d=replyHelper.quotedMessage.height();0!=d&&replyHelper.quotedMessage.attr("style","position : absolute;left:"+a.pageX+"px;top:"+(a.pageY-(d+30))+"px;z-index : 3;min-width : 0px;")}});$(document).on("mouseenter",".reply-info",function(a){var d=null;a=$(this).attr("href");var k=a.lastIndexOf("#");
a=a.substr(k+1);var e=$("#message-"+a);if(0<e.length){d=$(".content",e).html();a=e.parents(".user-container").hasClass("mine");var k=null,f=$(".timestamp",e),m=$(e).siblings(".timestamp");0<f.length?k=f:0<m.length&&(k=m);f=null;m=e.parents(".messages").siblings(".signature");0<m.length&&(f=m.clone(),m=$(".tiny-signature",f).detach(),$(f).empty().append(m),$(m).show(),e=e.parents(".messages").css("background-color"),f.attr("style","background-color : "+e+";width : inherit;border-top : 1px solid black;border-right : 1px solid black;border-left : 1px solid black;border-top-left-radius : 6px;border-top-right-radius : 6px;padding : 2px 5px 2px 5px;z-index : 2;position : relative;top : 1px;"));
d=$("<div class='user-container monologue'><div class='messages'><div class='message'><div class='content'>"+d+"</div></div></div></div>");d.attr("style","position : absolute;top : -9999;");$(".messages",d).attr("style","border : 1px solid black;border-top-left-radius : 0;max-width : 660px;width : inherit;");a&&d.addClass("mine");k&&(a=$("<div class='timestamp'>"+k.text()+"</div>"),$(".message",d).before(a));f&&$(".messages",d).before(f);$(this).parents(".monologue").before(d);replyHelper.quotedMessage=
d}});$(document).on("mouseleave",".reply-info",function(a){null!=replyHelper.quotedMessage&&(replyHelper.quotedMessage.remove(),replyHelper.quotedMessage=null)})}};var replyHelper=new ReplyHelper;
